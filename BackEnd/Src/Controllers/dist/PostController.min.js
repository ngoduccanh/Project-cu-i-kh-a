"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _Post=_interopRequireDefault(require("../Model/Post.js")),_Comment=_interopRequireDefault(require("../Model/Comment.js")),_Shape=_interopRequireDefault(require("../Model/Shape.js"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var PostController={createPost:function(t,r){var n,a,s,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.body,a=n.image,s=n.caption){e.next=3;break}return e.abrupt("return",r.status(400).json({error:"Image bắt buộc"}));case 3:return e.prev=3,u=new _Post.default({author:t.user._id,image:a,caption:s,likes:[],comments:[]}),e.next=7,regeneratorRuntime.awrap(u.save());case 7:r.status(201).json({message:"Tạo post thành công",post:u}),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(3),r.status(500).json({error:"Lỗi khi tạo post"});case 13:case"end":return e.stop()}},null,null,[[3,10]])},getAllPosts:function(e,t){var r;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(_Post.default.find().populate("author","username avatar").populate({path:"comments",populate:{path:"author",select:"username avatar"}}).sort({createdAt:-1}));case 3:r=e.sent,t.json(r),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),t.status(500).json({error:"Lỗi khi lấy posts"});case 10:case"end":return e.stop()}},null,null,[[0,7]])},getUserPosts:function(t,r){var n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.user._id,e.next=4,regeneratorRuntime.awrap(_Post.default.find({author:n}).populate("author","username avatar").populate({path:"comments",populate:{path:"author",select:"username avatar"}}).sort({createdAt:-1}));case 4:a=e.sent,r.json({posts:a}),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),r.status(500).json({error:"Lỗi khi lấy posts của user"});case 11:case"end":return e.stop()}},null,null,[[0,8]])},getPostsByUserId:function(t,r){var n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.params.userId,e.next=4,regeneratorRuntime.awrap(_Post.default.find({author:n}).populate("author","username avatar").populate({path:"comments",populate:{path:"author",select:"username avatar"}}).sort({createdAt:-1}));case 4:a=e.sent,r.json({posts:a}),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(0),console.error("Lỗi khi lấy post của userId:",e.t0),r.status(500).json({error:"Lỗi khi lấy bài viết của người dùng"});case 12:case"end":return e.stop()}},null,null,[[0,8]])},createComment:function(t,r){var n,a,s,u,o,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.body,a=n.postId,s=n.text){e.next=3;break}return e.abrupt("return",r.status(400).json({error:"Text bắt buộc"}));case 3:return e.prev=3,u=new _Comment.default({post:a,author:t.user._id,text:s}),e.next=7,regeneratorRuntime.awrap(u.save());case 7:return e.next=9,regeneratorRuntime.awrap(_Post.default.findById(a));case 9:return(o=e.sent).comments.push(u._id),e.next=13,regeneratorRuntime.awrap(o.save());case 13:return e.next=15,regeneratorRuntime.awrap(_Comment.default.findById(u._id).populate("author","username avatar"));case 15:c=e.sent,r.status(201).json({message:"Tạo comment thành công",comment:c}),e.next=23;break;case 19:e.prev=19,e.t0=e.catch(3),console.error(e.t0),r.status(500).json({error:"Lỗi khi tạo comment"});case 23:case"end":return e.stop()}},null,null,[[3,19]])},getComments:function(t,r){var n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.postId,e.prev=1,e.next=4,regeneratorRuntime.awrap(_Comment.default.find({post:n}).populate("author",["username","avatar"]));case 4:a=e.sent,r.status(200).json(a),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(1),console.error("Lỗi khi lấy bình luận:",e.t0),r.status(500).json({message:"Lỗi khi lấy bình luận"});case 12:case"end":return e.stop()}},null,null,[[1,8]])},DeleteComment:function(t,r){var n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.commentId,e.prev=1,e.next=4,regeneratorRuntime.awrap(_Comment.default.findById(n));case 4:if(a=e.sent){e.next=7;break}return e.abrupt("return",r.status(404).json({message:"Không tìm thấy bình luận"}));case 7:if(a.author.toString()!==t.user._id.toString())return e.abrupt("return",r.status(403).json({message:"Bạn không có quyền xóa bình luận này"}));e.next=9;break;case 9:return e.next=11,regeneratorRuntime.awrap(_Post.default.findByIdAndUpdate(a.post,{$pull:{comments:a._id}}));case 11:return e.next=13,regeneratorRuntime.awrap(_Comment.default.findByIdAndDelete(n));case 13:r.status(200).json({message:"Xóa bình luận thành công"}),e.next=20;break;case 16:e.prev=16,e.t0=e.catch(1),console.error("Lỗi khi xoá bình luận:",e.t0),r.status(500).json({message:"Lỗi server khi xoá bình luận"});case 20:case"end":return e.stop()}},null,null,[[1,16]])},DeletePost:function(t,r){var n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.postId,e.prev=1,e.next=4,regeneratorRuntime.awrap(_Post.default.findById(n));case 4:if(a=e.sent){e.next=7;break}return e.abrupt("return",r.status(404).json({message:"Không tìm thấy bài post"}));case 7:if(a.author.toString()!==t.user._id.toString())return e.abrupt("return",r.status(403).json({message:"Bạn không có quyền xóa bài viết này"}));e.next=9;break;case 9:return e.next=11,regeneratorRuntime.awrap(_Comment.default.deleteMany({_id:{$in:a.comments}}));case 11:return e.next=13,regeneratorRuntime.awrap(_Post.default.findByIdAndDelete(n));case 13:r.status(200).json({message:"Xóa bài viết thành công"}),e.next=20;break;case 16:e.prev=16,e.t0=e.catch(1),console.error("Lỗi khi xoá bài viết:",e.t0),r.status(500).json({message:"Lỗi server khi xoá bài viết"});case 20:case"end":return e.stop()}},null,null,[[1,16]])},SavedPost:function(t,r){var n,a,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body.postId,a=t.user._id,e.prev=2,e.next=5,regeneratorRuntime.awrap(_Shape.default.findOne({user:a,post:n}));case 5:if(e.sent)return e.abrupt("return",r.status(400).json({message:"Đã lưu trước đó"}));e.next=8;break;case 8:return s=new _Shape.default({user:a,post:n}),e.next=11,regeneratorRuntime.awrap(s.save());case 11:r.status(201).json({message:"Đã shape bài viết"}),e.next=17;break;case 14:e.prev=14,e.t0=e.catch(2),r.status(500).json({message:"Lỗi server",error:e.t0.message});case 17:case"end":return e.stop()}},null,null,[[2,14]])},GetSavedPost:function(t,r){var n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.user._id,e.next=4,regeneratorRuntime.awrap(_Shape.default.find({user:n}).populate({path:"post",populate:{path:"author",select:"username avatar"}}));case 4:a=e.sent,r.json(a),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),r.status(500).json({message:"Lỗi khi lấy danh sách",error:e.t0.message});case 11:case"end":return e.stop()}},null,null,[[0,8]])},deleteSavedPost:function(t,r){var n,a,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.postId,a=t.user._id,e.prev=2,e.next=5,regeneratorRuntime.awrap(_Shape.default.findOne({user:a,post:n}));case 5:if(s=e.sent){e.next=8;break}return e.abrupt("return",r.status(404).json({message:"Bài viết chưa được lưu hoặc đã bị xóa"}));case 8:return e.next=10,regeneratorRuntime.awrap(_Shape.default.deleteOne({_id:s._id}));case 10:r.status(200).json({message:"Đã xóa bài viết đã lưu"}),e.next=17;break;case 13:e.prev=13,e.t0=e.catch(2),console.error("Lỗi khi xóa bài viết đã lưu:",e.t0),r.status(500).json({message:"Lỗi máy chủ"});case 17:case"end":return e.stop()}},null,null,[[2,13]])}},_default=PostController;exports.default=_default;
//# sourceMappingURL=PostController.min.js.map
